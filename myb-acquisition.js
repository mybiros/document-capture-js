const UtilsconvertBase64=s=>{return new Promise((e,t)=>{const i=new FileReader;i.readAsDataURL(s);i.onload=()=>{e(i.result)};i.onerror=e=>{t(e)}})};class MyBAcquisitionUtils{static isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}class MyBDocument{static DOCUMENT_WIDTH=1280;static DOCUMENT_HEIGHT=720}class MyBAcquisitionCropper{constructor(e,t){this.clientID=e;this.clientSecret=t}async doCropRequest(e){var t=new Headers;t.append("x-api-key",this.clientID);t.append("x-mybiros-key",this.clientSecret);var i={method:"POST",headers:t,body:e};let s=[];try{s=await fetch("https://ey6p5j1ode.execute-api.eu-central-1.amazonaws.com/Prod/inference",i).then(e=>e.json()).then(e=>{return e.Pages[0].Detections}).catch(e=>{return[]})}catch{return[]}return s}async cropImage(e){let t=false;if(e.cols>e.rows){cv.rotate(e,e,cv.ROTATE_90_COUNTERCLOCKWISE);t=true}let i=e.cols/608;let s=e.rows/800;let n=new cv.Size(608,800);let o=new cv.Mat;cv.resize(e,o,n,0,0,cv.INTER_AREA);let r=document.createElement("canvas");cv.imshow(r,o);let a=r.toDataURL("image/jpeg");let c=a.replace(/^data:image\/?[A-z]*;base64,/,"");let h=await this.doCropRequest(c);if(h.length!=1){return null}let u=new cv.Mat;h=h[0];const l={x:h.BoundingBox[0]*i,y:h.BoundingBox[1]*s};const d={x:h.BoundingBox[2]*i,y:h.BoundingBox[3]*s};const m={x:Math.min(l.x,d.x),y:Math.min(l.y,d.y)};const v={x:Math.max(l.x,d.x),y:Math.max(l.y,d.y)};const p=10;m.x=m.x-p;m.y=m.y-p;v.x=v.x+p;v.y=v.y+p;const C=v.x-m.x;const y=v.y-m.y;if(m.x<p||m.y<p||v.x>e.cols-p||v.y>e.rows-p){return null}let w=new cv.Rect(m.x,m.y,C,y);u=e.roi(w);if(u.rows>u.cols){cv.rotate(u,u,cv.ROTATE_90_COUNTERCLOCKWISE)}return u}async processImage(e){let t=cv.imread(e,cv.IMREAD_UNCHANGED);let i=new cv.Size(Math.ceil(t.cols/2),Math.ceil(t.rows/2));cv.resize(t,t,i,0,0,cv.INTER_AREA);let s=document.createElement("canvas");let n=await this.cropImage(t);if(!n){return null}cv.imshow(s,n);let o=s.toDataURL("image/jpeg");return o}}class MyBAcquisitionProcessUI{constructor(){this.checkExists=(e,t)=>{if(!e){throw new Error(`${t} is not initialized.`)}};this.rootElement=document.getElementById("acquisition-root-component");this.checkExists(this.rootElement,"Component Root element");this.activeCameraContainer=this.rootElement.querySelector("#acquisition-active-camera-container");this.checkExists(this.activeCameraContainer,"active camera Container");this.stepsContainer=this.rootElement.querySelector("#acquisition-steps-container");this.checkExists(this.stepsContainer,"steps Container");this.previewContainer=this.rootElement.querySelector("#acquisition-doc-preview-contaner");this.checkExists(this.previewContainer,"preview Container");this.processingContainer=this.rootElement.querySelector("#acquisition-processing-container");this.checkExists(this.processingContainer,"processing Container");this.stepAcquisitionBtn=this.rootElement.querySelector("#acquisition-btn");this.checkExists(this.stepAcquisitionBtn,"step Acquisition Button");this.screenshotBtn=this.rootElement.querySelector("#acquisition-video-screenshot-control");this.checkExists(this.screenshotBtn,"screenshot Button");this.videoSource=this.rootElement.querySelector("#acquisition-video-source");this.checkExists(this.videoSource,"video Element");this.imagePreview=this.rootElement.querySelector("#acquisition-doc-preview");this.checkExists(this.videoSource,"image preview Element");this.passiveImageSourceInput=this.rootElement.querySelector("#acquisition-passive-camera-input");this.checkExists(this.passiveImageSourceInput,"passive image Source Input")}hideComponent(){this.rootElement.classList.add("d-none")}showActiveCamera(){this.activeCameraContainer.classList.remove("d-none")}hideActiveCamera(){this.activeCameraContainer.classList.add("d-none")}showStepPreview(){this.stepsContainer.classList.remove("d-none")}hideStepPreview(){this.stepsContainer.classList.add("d-none")}showProcessingContainer(){this.processingContainer.classList.remove("d-none")}hideProcessingContainer(){this.processingContainer.classList.add("d-none")}clearPreviewImage(){this.imagePreview.src=""}setStepAcquisitionBtnTitle(e){this.stepAcquisitionBtn.innerHTML=e}}class MyBActiveCamera{static DEVICE_CONFIG={video:{aspectRatio:4/3,resizeMode:"none",facingMode:"environment",width:{min:1440,ideal:2560,max:2560},height:{min:1080,ideal:1920,max:1920},frameRate:{min:30}}};constructor(e,t,i){this.video=e;this.screenshotBtn=t;this.onAcquireCallback=i;this.videoInfo=document.getElementById("active-camera-info");this.videoWarning=document.getElementById("active-camera-warning");this.videoInfoUpdate=null;this.screenshotBtn.addEventListener("click",async()=>{await this.takeScreenshot()});this.video.addEventListener("play",()=>{this.videoInfo.classList.remove("d-none");setTimeout(()=>{this.videoInfo.classList.add("d-none")},5e3)})}async closeUserCam(){this.video.srcObject.getTracks().forEach(e=>e.stop());this.video.srcObject=null}async openUserCam(){let e=await this.startStream();if(!e){throw new Error("Streaming active camera not available")}}async updateSteamInfo(){let e=this.video.srcObject.getTracks()[0].getSettings();this.videoInfo.innerHTML=`<p>Fps ${e.frameRate} Res: ${e.width}x${e.height}</p>
        <p>${this.video.videoWidth}x${this.video.videoHeight}</p>`}startStream=async()=>{let e=false;try{e=await navigator.mediaDevices.getUserMedia(MyBActiveCamera.DEVICE_CONFIG).then(e=>{this.video.srcObject=e;return true}).catch(e=>{return false})}catch(e){}return e};async takeScreenshot(){if(this.video.readyState!=4){return null}let e=document.createElement("canvas");e.width=this.video.videoWidth;e.height=this.video.videoHeight;let t=e.getContext("2d");t.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight,0,0,t.canvas.width,t.canvas.height);this.onAcquireCallback(e.toDataURL());this.closeUserCam()}}class MyBPassiveCamera{constructor(e,t){this.image=e;this.onAcquireCallback=t;this.image.addEventListener("change",async()=>{let e=UtilsconvertBase64(this.image.files[0]);e.then(e=>{this.onAcquireCallback(e)}).catch(e=>{this.onAcquireCallback(null)})})}async openUserCam(){this.image.click()}}class MyBAcquisitionProcess{static ACQUISITION_PHASE_TITLES=["Fai una foto del documento (davanti / esterno aperto)","Invia Foto","Fai una foto del documento (dietro / interno aperto)","Invia Foto"];constructor({serviceClientID:e,serviceToken:t,retryLimit:i=3}){this.acquisition_step=-1;this.isPreviewActive=true;this.isDocFront=true;this.document=new MyBDocument;this.ui=new MyBAcquisitionProcessUI;this.activeCam=new MyBActiveCamera(this.ui.videoSource,this.ui.screenshotBtn,this.loadPrimaryImage.bind(this));this.passiveCam=new MyBPassiveCamera(this.ui.passiveImageSourceInput,this.loadPrimaryImage.bind(this));this.primaryImage=document.createElement("img");this.documentLocalUrl="";this.isActiveCameraAvailable=true;this.retryLimit=i;this.retryCounter=0;this.cropper=new MyBAcquisitionCropper(e,t);this.primaryImage.addEventListener("load",async()=>{let e=await this.cropper.processImage(this.primaryImage);if(!e){if(this.retryCounter>=this.retryLimit){this.stop();this.onProcessError();return}else{this.retryCounter+=1;this.refreshCurrentStep();this.onCroppingError({currentRetryCount:this.retryCounter,retryLimit:this.retryLimit});return}}this.retryCounter=0;this.documentLocalUrl=e;this.ui.imagePreview.src=this.documentLocalUrl;await this.doNextStep()})}refreshCurrentStep(){this.acquisition_step-=1;this.ui.hideProcessingContainer();this.ui.hideActiveCamera();this.ui.hideStepPreview();this.isPreviewActive=true;this.ui.showStepPreview()}setAcquisitionActionsCallBack(e){const{onProcessError:t,onCroppingError:i,onSendDocument:s,onAcquisitionEnd:n}=e;this.onProcessError=t;this.onCroppingError=i;this.onSendDocument=s;this.onAcquisitionEnd=n}async loadPrimaryImage(e){this.primaryImage.src=e;this.ui.hideActiveCamera();this.ui.hideStepPreview();this.ui.showProcessingContainer()}async openUserCam(){if(!this.isActiveCameraAvailable){await this.passiveCam.openUserCam();return true}try{await this.activeCam.openUserCam();this.ui.showActiveCamera();return true}catch(e){return false}}async start(){this.ui.hideProcessingContainer();this.ui.showStepPreview()}async stop(){this.acquisition_step=999;this.ui.hideComponent()}async sendDocumentData(){this.onSendDocument(this.documentLocalUrl,this.isDocFront?"front":"back");this.isDocFront=!this.isDocFront}async showNextStep(){this.ui.showStepPreview()}async doNextStep(){this.acquisition_step+=1;this.ui.setStepAcquisitionBtnTitle(MyBAcquisitionProcess.ACQUISITION_PHASE_TITLES[this.acquisition_step]);if(MyBAcquisitionProcess.ACQUISITION_PHASE_TITLES[this.acquisition_step]===undefined){if(this.acquisition_step==4){await this.sendDocumentData();this.onAcquisitionEnd()}this.stop();return}this.ui.hideProcessingContainer();this.ui.hideActiveCamera();this.ui.hideStepPreview();if(this.acquisition_step%2==0){if(this.isPreviewActive){this.isPreviewActive=false;let e=await this.openUserCam();if(!e){this.isActiveCameraAvailable=false;this.isPreviewActive=true;this.acquisition_step-=1;this.ui.showStepPreview()}}else{await this.sendDocumentData();this.acquisition_step-=1;this.isPreviewActive=true;this.ui.clearPreviewImage()}}else{this.ui.showStepPreview()}}}